<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الرصيد</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --background-color: #ecf0f1;
            --text-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --border-radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--primary-color);
            color: white;
            border-radius: var(--border-radius);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--primary-color);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 1.1rem;
            margin-bottom: 10px;
            opacity: 0.8;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
        }

        form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--primary-color);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        button {
            background: var(--secondary-color);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background 0.3s;
        }

        button:hover {
            background: #2980b9;
        }

        .btn-danger {
            background: var(--accent-color);
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: var(--success-color);
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: var(--warning-color);
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-print {
            background: #9b59b6;
        }

        .btn-print:hover {
            background: #8e44ad;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        th, td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-deposit {
            background: #d4edda;
            color: #155724;
        }

        .badge-expense {
            background: #f8d7da;
            color: #721c24;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
        }

        .print-section {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1000;
            padding: 50px;
            overflow: auto;
        }

        .close-print {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 2rem;
            cursor: pointer;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .print-section, .print-section * {
                visibility: visible;
            }
            .print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
            }
            .close-print {
                display: none;
            }
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: var(--secondary-color);
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 20px 0;
            text-align: center;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            form {
                grid-template-columns: 1fr;
            }
            
            .filters {
                grid-template-columns: 1fr;
            }
            
            th, td {
                padding: 10px 8px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>نظام إدارة الرصيد</h1>
            <p class="subtitle">إدارة مالية بسيطة وفعالة</p>
            <p id="last-update">آخر تحديث: --:--:--</p>
        </header>

        <div class="dashboard">
            <div class="stat-card">
                <h3>الرصيد الحالي</h3>
                <div class="value" id="current-balance">0.00</div>
                <div>د.ل</div>
            </div>
            <div class="stat-card">
                <h3>إجمالي الإيداعات</h3>
                <div class="value" id="total-deposits">0.00</div>
                <div>د.ل</div>
            </div>
            <div class="stat-card">
                <h3>إجمالي المصروفات</h3>
                <div class="value" id="total-expenses">0.00</div>
                <div>د.ل</div>
            </div>
            <div class="stat-card">
                <h3>عدد الحركات</h3>
                <div class="value" id="total-transactions">0</div>
                <div>حركة</div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">إضافة حركة جديدة</h2>
            <form id="transaction-form">
                <div class="form-group">
                    <label for="transaction-type">نوع الحركة</label>
                    <select id="transaction-type" required>
                        <option value="">-- اختر نوع الحركة --</option>
                        <option value="deposit">إيداع</option>
                        <option value="expense">مصروف</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="amount">المبلغ (د.ل)</label>
                    <input type="number" id="amount" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="transaction-date">التاريخ</label>
                    <input type="date" id="transaction-date" required>
                </div>
                <div class="form-group">
                    <label for="debtor">اختر الدائن</label>
                    <select id="debtor">
                        <option value="">-- اختر الدائن --</option>
                        <!-- سيتم تعبئته ديناميكيًا -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="description">الوصف</label>
                    <textarea id="description" rows="2"></textarea>
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <button type="submit">إضافة الحركة</button>
                </div>
            </form>
        </div>

        <div class="section">
            <h2 class="section-title">فلترة الحركات</h2>
            <div class="filters">
                <div class="form-group">
                    <label for="filter-type">نوع الحركة</label>
                    <select id="filter-type">
                        <option value="all">الكل</option>
                        <option value="deposit">إيداع فقط</option>
                        <option value="expense">مصروف فقط</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filter-debtor">الدائن</label>
                    <select id="filter-debtor">
                        <option value="all">الكل</option>
                        <!-- سيتم تعبئته ديناميكيًا -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="filter-from-date">من تاريخ</label>
                    <input type="date" id="filter-from-date">
                </div>
                <div class="form-group">
                    <label for="filter-to-date">إلى تاريخ</label>
                    <input type="date" id="filter-to-date">
                </div>
                <div class="form-group" style="display: flex; gap: 10px; align-items: flex-end;">
                    <button type="button" id="apply-filter">تطبيق الفلترة</button>
                    <button type="button" id="reset-filter" class="btn-warning">إعادة تعيين</button>
                </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button type="button" id="show-expenses-only" class="btn-danger">إظهار المصروفات فقط</button>
                <button type="button" id="show-deposits-only" class="btn-success">إظهار الإيداعات فقط</button>
                <button type="button" id="show-all" class="btn-warning">إظهار الكل</button>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">خيارات الطباعة</h2>
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button type="button" id="print-transactions" class="btn-print">طباعة سجل الحركات المالية</button>
                <button type="button" id="preview-print" class="btn-print">معاينة قبل الطباعة</button>
                <button type="button" id="print-summary" class="btn-print">طباعة ملخص الحساب</button>
                <button type="button" id="print-current-view" class="btn-print">طباعة العرض الحالي</button>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">سجل الحركات المالية</h2>
            <button type="button" id="clear-all-transactions" class="btn-danger" style="margin-bottom: 20px;">مسح الكل</button>
            <div id="transactions-loading" class="loading">جارٍ تحميل الحركات...</div>
            <table id="transactions-table">
                <thead>
                    <tr>
                        <th>التاريخ</th>
                        <th>النوع</th>
                        <th>الوصف</th>
                        <th>الدائن</th>
                        <th>المبلغ</th>
                        <th>الرصيد بعد الحركة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="transactions-body">
                    <!-- سيتم تعبئته ديناميكيًا -->
                </tbody>
            </table>
            <div id="no-transactions" style="text-align: center; padding: 30px; display: none;">
                لا توجد حركات مالية مسجلة
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">إضافة حساب دائن جديد</h2>
            <form id="account-form">
                <div class="form-group">
                    <label for="account-name">اسم الدائن</label>
                    <input type="text" id="account-name" required>
                </div>
                <div class="form-group">
                    <label for="account-phone">رقم الهاتف</label>
                    <input type="tel" id="account-phone">
                </div>
                <div class="form-group">
                    <label for="account-notes">ملاحظات</label>
                    <textarea id="account-notes" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <button type="submit">إضافة الحساب</button>
                </div>
            </form>
        </div>

        <div class="section">
            <h2 class="section-title">قائمة الدائنين</h2>
            <div id="accounts-loading" class="loading">جارٍ تحميل الدائنين...</div>
            <table id="accounts-table">
                <thead>
                    <tr>
                        <th>اسم الدائن</th>
                        <th>رقم الهاتف</th>
                        <th>الرصيد</th>
                        <th>عدد الحركات</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="accounts-body">
                    <!-- سيتم تعبئته ديناميكيًا -->
                </tbody>
            </table>
            <div id="no-accounts" style="text-align: center; padding: 30px; display: none;">
                لا توجد حسابات دائنين مسجلة
            </div>
        </div>
    </div>

    <!-- معاينة الطباعة -->
    <div id="print-preview" class="print-section">
        <span class="close-print" onclick="closePrintPreview()">&times;</span>
        <div id="print-content">
            <!-- سيتم تعبئته ديناميكيًا -->
        </div>
    </div>

    <!-- كشف حساب الدائن -->
    <div id="account-statement" class="print-section">
        <span class="close-print" onclick="closeAccountStatement()">&times;</span>
        <h2>كشف حساب الدائن</h2>
        <p><strong>اسم الدائن:</strong> <span id="statement-debtor-name"></span></p>
        <p><strong>رقم الهاتف:</strong> <span id="statement-debtor-phone"></span></p>
        <p><strong>الرصيد الحالي:</strong> <span id="statement-debtor-balance"></span> د.ل</p>
        <table>
            <thead>
                <tr>
                    <th>التاريخ</th>
                    <th>النوع</th>
                    <th>الوصف</th>
                    <th>المبلغ</th>
                    <th>الرصيد بعد الحركة</th>
                </tr>
            </thead>
            <tbody id="statement-transactions">
                <!-- سيتم تعبئته ديناميكيًا -->
            </tbody>
        </table>
    </div>

    <!-- نموذج استلام السلفة -->
    <div id="advance-receipt" class="print-section">
        <span class="close-print" onclick="closeAdvanceReceipt()">&times;</span>
        <h2>نموذج استلام السلفة</h2>
        <div id="advance-content">
            <!-- سيتم تعبئته ديناميكيًا -->
        </div>
    </div>

    <script>
        // Declare Supabase variables (will be initialized later)
        let supabase;
        const supabaseUrl = 'https://fbexycaxggsxyphgmvui.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZiZXh5Y2F4Z2dzeHlwaGdtdnVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MTY3ODAsImV4cCI6MjA3NDE5Mjc4MH0.u0jPS3ZfrksfWZ07FiyAjHuPM1a1r2grunzNtZRTwHk';

        // DOM Elements
        const transactionForm = document.getElementById('transaction-form');
        const accountForm = document.getElementById('account-form');
        const debtorSelect = document.getElementById('debtor');
        const filterDebtorSelect = document.getElementById('filter-debtor');
        const transactionsBody = document.getElementById('transactions-body');
        const accountsBody = document.getElementById('accounts-body');
        const currentBalance = document.getElementById('current-balance');
        const totalDeposits = document.getElementById('total-deposits');
        const totalExpenses = document.getElementById('total-expenses');
        const totalTransactions = document.getElementById('total-transactions');
        const lastUpdate = document.getElementById('last-update');
        const applyFilterBtn = document.getElementById('apply-filter');
        const resetFilterBtn = document.getElementById('reset-filter');
        const showExpensesOnlyBtn = document.getElementById('show-expenses-only');
        const showDepositsOnlyBtn = document.getElementById('show-deposits-only');
        const showAllBtn = document.getElementById('show-all');
        const printTransactionsBtn = document.getElementById('print-transactions');
        const previewPrintBtn = document.getElementById('preview-print');
        const printSummaryBtn = document.getElementById('print-summary');
        const printCurrentViewBtn = document.getElementById('print-current-view');
        const clearAllTransactionsBtn = document.getElementById('clear-all-transactions');
        const transactionsLoading = document.getElementById('transactions-loading');
        const accountsLoading = document.getElementById('accounts-loading');
        const noTransactions = document.getElementById('no-transactions');
        const noAccounts = document.getElementById('no-accounts');
        const printPreview = document.getElementById('print-preview');
        const printContent = document.getElementById('print-content');
        const accountStatement = document.getElementById('account-statement');
        const statementDebtorName = document.getElementById('statement-debtor-name');
        const statementDebtorPhone = document.getElementById('statement-debtor-phone');
        const statementDebtorBalance = document.getElementById('statement-debtor-balance');
        const statementTransactions = document.getElementById('statement-transactions');
        const advanceReceipt = document.getElementById('advance-receipt');
        const advanceContent = document.getElementById('advance-content');

        // Global variables
        let allTransactions = [];
        let allAccounts = [];
        let filteredTransactions = [];

        // Initialize the application
        async function init() {
            // Initialize Supabase client HERE, inside init()
            supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

            updateLastUpdate();
            await loadAccounts();
            await loadTransactions();
            setupEventListeners();
        }

        // Update last update time
        function updateLastUpdate() {
            const now = new Date();
            lastUpdate.textContent = `آخر تحديث: ${now.toLocaleTimeString('ar-EG')}`;
        }

        // Load all accounts from Supabase
        async function loadAccounts() {
            accountsLoading.style.display = 'block';
            noAccounts.style.display = 'none';
            
            try {
                const { data, error } = await supabase
                    .from('accounts')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allAccounts = data || [];
                renderAccounts();
                populateDebtorSelects();
            } catch (error) {
                console.error('Error loading accounts:', error);
                alert('حدث خطأ أثناء تحميل الحسابات: ' + error.message);
            } finally {
                accountsLoading.style.display = 'none';
            }
        }

        // Load all transactions from Supabase
        async function loadTransactions() {
            transactionsLoading.style.display = 'block';
            noTransactions.style.display = 'none';
            
            try {
                const { data, error } = await supabase
                    .from('transactions')
                    .select('*')
                    .order('date', { ascending: false })
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allTransactions = data || [];
                filteredTransactions = [...allTransactions];
                renderTransactions();
                updateDashboardStats();
            } catch (error) {
                console.error('Error loading transactions:', error);
                alert('حدث خطأ أثناء تحميل الحركات: ' + error.message);
            } finally {
                transactionsLoading.style.display = 'none';
            }
        }

        // Render accounts in the table
        function renderAccounts() {
            accountsBody.innerHTML = '';
            
            if (allAccounts.length === 0) {
                noAccounts.style.display = 'block';
                return;
            }

            noAccounts.style.display = 'none';

            allAccounts.forEach(account => {
                const row = document.createElement('tr');
                
                // Calculate number of transactions for this account
                const accountTransactions = allTransactions.filter(t => t.debtor_id === account.id);
                const transactionCount = accountTransactions.length;

                row.innerHTML = `
                    <td>${account.name}</td>
                    <td>${account.phone || 'غير متوفر'}</td>
                    <td>${parseFloat(account.balance).toFixed(2)} د.ل</td>
                    <td>${transactionCount}</td>
                    <td class="actions">
                        <button onclick="viewAccountStatement(${account.id})" class="btn-success">كشف حساب</button>
                        <button onclick="deleteAccount(${account.id})" class="btn-danger">حذف</button>
                    </td>
                `;
                accountsBody.appendChild(row);
            });
        }

        // Render transactions in the table
        function renderTransactions() {
            transactionsBody.innerHTML = '';
            
            if (filteredTransactions.length === 0) {
                noTransactions.style.display = 'block';
                return;
            }

            noTransactions.style.display = 'none';

            filteredTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                
                // Find debtor name
                let debtorName = 'غير محدد';
                if (transaction.debtor_id) {
                    const debtor = allAccounts.find(acc => acc.id === transaction.debtor_id);
                    debtorName = debtor ? debtor.name : transaction.debtor_name || 'غير محدد';
                } else if (transaction.debtor_name) {
                    debtorName = transaction.debtor_name;
                }

                row.innerHTML = `
                    <td>${formatDate(transaction.date)}</td>
                    <td><span class="badge ${transaction.type === 'deposit' ? 'badge-deposit' : 'badge-expense'}">
                        ${transaction.type === 'deposit' ? 'إيداع' : 'مصروف'}
                    </span></td>
                    <td>${transaction.description || 'بدون وصف'}</td>
                    <td>${debtorName}</td>
                    <td>${parseFloat(transaction.amount).toFixed(2)} د.ل</td>
                    <td>${parseFloat(transaction.balance_after).toFixed(2)} د.ل</td>
                    <td class="actions">
                        <button onclick="editTransaction(${transaction.id})" class="btn-warning">تعديل</button>
                        <button onclick="deleteTransaction(${transaction.id})" class="btn-danger">حذف</button>
                    </td>
                `;
                transactionsBody.appendChild(row);
            });
        }

        // Populate debtor selects
        function populateDebtorSelects() {
            // Clear existing options except the first one
            while (debtorSelect.options.length > 1) {
                debtorSelect.remove(1);
            }
            while (filterDebtorSelect.options.length > 1) {
                filterDebtorSelect.remove(1);
            }

            // Add accounts to selects
            allAccounts.forEach(account => {
                const option1 = document.createElement('option');
                option1.value = account.id;
                option1.textContent = account.name;
                debtorSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = account.id;
                option2.textContent = account.name;
                filterDebtorSelect.appendChild(option2);
            });
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            const deposits = allTransactions
                .filter(t => t.type === 'deposit')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            const expenses = allTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            const balance = deposits - expenses;
            const count = allTransactions.length;

            currentBalance.textContent = balance.toFixed(2);
            totalDeposits.textContent = deposits.toFixed(2);
            totalExpenses.textContent = expenses.toFixed(2);
            totalTransactions.textContent = count;

            // Update last update time
            updateLastUpdate();
        }

        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-EG');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Transaction form submission
            transactionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                await addTransaction();
            });

            // Account form submission
            accountForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                await addAccount();
            });

            // Filter buttons
            applyFilterBtn.addEventListener('click', applyFilters);
            resetFilterBtn.addEventListener('click', resetFilters);
            showExpensesOnlyBtn.addEventListener('click', () => showFilteredTransactions('expense'));
            showDepositsOnlyBtn.addEventListener('click', () => showFilteredTransactions('deposit'));
            showAllBtn.addEventListener('click', () => showFilteredTransactions('all'));

            // Print buttons
            printTransactionsBtn.addEventListener('click', () => printTransactions('all'));
            previewPrintBtn.addEventListener('click', () => previewTransactions());
            printSummaryBtn.addEventListener('click', printSummary);
            printCurrentViewBtn.addEventListener('click', () => printTransactions('current'));

            // Clear all transactions
            clearAllTransactionsBtn.addEventListener('click', clearAllTransactions);
        }

        // Add a new transaction
        async function addTransaction() {
            const type = document.getElementById('transaction-type').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const date = document.getElementById('transaction-date').value;
            const debtorId = document.getElementById('debtor').value || null;
            const description = document.getElementById('description').value.trim();

            if (!type || !amount || !date) {
                alert('يرجى ملء جميع الحقول المطلوبة');
                return;
            }

            try {
                // Calculate balance after this transaction
                const lastBalance = allTransactions.length > 0 ? 
                    parseFloat(allTransactions[0].balance_after) : 0;
                const balanceAfter = type === 'deposit' ? 
                    lastBalance + amount : lastBalance - amount;

                // Get debtor name if debtor_id is provided
                let debtorName = null;
                if (debtorId) {
                    const debtor = allAccounts.find(acc => acc.id == debtorId);
                    debtorName = debtor ? debtor.name : null;
                }

                // Insert transaction into Supabase
                const { data, error } = await supabase
                    .from('transactions')
                    .insert([
                        {
                            type,
                            amount,
                            date,
                            debtor_id: debtorId,
                            debtor_name: debtorName,
                            description,
                            balance_after: balanceAfter
                        }
                    ])
                    .select();

                if (error) throw error;

                // Update local data and UI
                const newTransaction = data[0];
                allTransactions.unshift(newTransaction);
                filteredTransactions = [...allTransactions];
                renderTransactions();
                updateDashboardStats();

                // Reset form
                transactionForm.reset();
                document.getElementById('transaction-date').valueAsDate = new Date();

                alert('تمت إضافة الحركة بنجاح');
            } catch (error) {
                console.error('Error adding transaction:', error);
                alert('حدث خطأ أثناء إضافة الحركة: ' + error.message);
            }
        }

        // Add a new account
        async function addAccount() {
            const name = document.getElementById('account-name').value.trim();
            const phone = document.getElementById('account-phone').value.trim();
            const notes = document.getElementById('account-notes').value.trim();

            if (!name) {
                alert('يرجى إدخال اسم الدائن');
                return;
            }

            try {
                // Insert account into Supabase
                const { data, error } = await supabase
                    .from('accounts')
                    .insert([
                        {
                            name,
                            phone: phone || null,
                            notes: notes || null,
                            balance: 0
                        }
                    ])
                    .select();

                if (error) throw error;

                // Update local data and UI
                const newAccount = data[0];
                allAccounts.unshift(newAccount);
                renderAccounts();
                populateDebtorSelects();

                // Reset form
                accountForm.reset();

                alert('تمت إضافة الحساب بنجاح');
            } catch (error) {
                console.error('Error adding account:', error);
                alert('حدث خطأ أثناء إضافة الحساب: ' + error.message);
            }
        }

        // Apply filters to transactions
        function applyFilters() {
            const type = document.getElementById('filter-type').value;
            const debtorId = document.getElementById('filter-debtor').value;
            const fromDate = document.getElementById('filter-from-date').value;
            const toDate = document.getElementById('filter-to-date').value;

            filteredTransactions = allTransactions.filter(transaction => {
                // Filter by type
                if (type !== 'all' && transaction.type !== type) {
                    return false;
                }

                // Filter by debtor
                if (debtorId !== 'all' && transaction.debtor_id != debtorId) {
                    return false;
                }

                // Filter by date range
                if (fromDate && transaction.date < fromDate) {
                    return false;
                }
                if (toDate && transaction.date > toDate) {
                    return false;
                }

                return true;
            });

            renderTransactions();
        }

        // Reset all filters
        function resetFilters() {
            document.getElementById('filter-type').value = 'all';
            document.getElementById('filter-debtor').value = 'all';
            document.getElementById('filter-from-date').value = '';
            document.getElementById('filter-to-date').value = '';

            filteredTransactions = [...allTransactions];
            renderTransactions();
        }

        // Show filtered transactions by type
        function showFilteredTransactions(type) {
            if (type === 'all') {
                filteredTransactions = [...allTransactions];
            } else {
                filteredTransactions = allTransactions.filter(t => t.type === type);
            }
            renderTransactions();
        }

        // View account statement
        async function viewAccountStatement(accountId) {
            const account = allAccounts.find(acc => acc.id === accountId);
            if (!account) return;

            statementDebtorName.textContent = account.name;
            statementDebtorPhone.textContent = account.phone || 'غير متوفر';
            statementDebtorBalance.textContent = parseFloat(account.balance).toFixed(2);

            // Get transactions for this account
            const accountTransactions = allTransactions.filter(t => t.debtor_id === accountId);
            statementTransactions.innerHTML = '';

            if (accountTransactions.length === 0) {
                statementTransactions.innerHTML = '<tr><td colspan="5" style="text-align: center;">لا توجد حركات لهذا الدائن</td></tr>';
            } else {
                accountTransactions.forEach(transaction => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatDate(transaction.date)}</td>
                        <td>${transaction.type === 'deposit' ? 'إيداع' : 'مصروف'}</td>
                        <td>${transaction.description || 'بدون وصف'}</td>
                        <td>${parseFloat(transaction.amount).toFixed(2)} د.ل</td>
                        <td>${parseFloat(transaction.balance_after).toFixed(2)} د.ل</td>
                    `;
                    statementTransactions.appendChild(row);
                });
            }

            accountStatement.style.display = 'block';
        }

        // Close account statement
        function closeAccountStatement() {
            accountStatement.style.display = 'none';
        }

        // Delete transaction
        async function deleteTransaction(transactionId) {
            if (!confirm('هل أنت متأكد أنك تريد حذف هذه الحركة؟')) {
                return;
            }

            try {
                // Delete transaction from Supabase
                const { error } = await supabase
                    .from('transactions')
                    .delete()
                    .eq('id', transactionId);

                if (error) throw error;

                // Update local data and UI
                allTransactions = allTransactions.filter(t => t.id !== transactionId);
                filteredTransactions = filteredTransactions.filter(t => t.id !== transactionId);
                renderTransactions();
                updateDashboardStats();

                alert('تم حذف الحركة بنجاح');
            } catch (error) {
                console.error('Error deleting transaction:', error);
                alert('حدث خطأ أثناء حذف الحركة: ' + error.message);
            }
        }

        // Delete account
        async function deleteAccount(accountId) {
            if (!confirm('هل أنت متأكد أنك تريد حذف هذا الحساب؟ سيتم حذف جميع الحركات المرتبطة به.')) {
                return;
            }

            try {
                // First, delete all transactions associated with this account
                const { error: transactionsError } = await supabase
                    .from('transactions')
                    .delete()
                    .eq('debtor_id', accountId);

                if (transactionsError) throw transactionsError;

                // Then, delete the account
                const { error: accountError } = await supabase
                    .from('accounts')
                    .delete()
                    .eq('id', accountId);

                if (accountError) throw accountError;

                // Update local data and UI
                allAccounts = allAccounts.filter(acc => acc.id !== accountId);
                allTransactions = allTransactions.filter(t => t.debtor_id !== accountId);
                filteredTransactions = filteredTransactions.filter(t => t.debtor_id !== accountId);
                
                renderAccounts();
                renderTransactions();
                populateDebtorSelects();
                updateDashboardStats();

                alert('تم حذف الحساب وجميع حركاته بنجاح');
            } catch (error) {
                console.error('Error deleting account:', error);
                alert('حدث خطأ أثناء حذف الحساب: ' + error.message);
            }
        }

        // Edit transaction (placeholder - can be expanded)
        function editTransaction(transactionId) {
            alert('وظيفة التعديل لم تُنفذ بعد. سيتم إضافتها في التحديثات القادمة.');
            // This function can be expanded to allow editing of transactions
        }

        // Print transactions
        function printTransactions(type) {
            let transactionsToPrint;
            let title = '';

            switch (type) {
                case 'all':
                    transactionsToPrint = allTransactions;
                    title = 'سجل جميع الحركات المالية';
                    break;
                case 'current':
                    transactionsToPrint = filteredTransactions;
                    title = 'سجل الحركات المالية (العرض الحالي)';
                    break;
                default:
                    transactionsToPrint = allTransactions;
                    title = 'سجل الحركات المالية';
            }

            let content = `
                <h2 style="text-align: center; margin-bottom: 30px;">${title}</h2>
                <table style="width: 100%; border-collapse: collapse; margin: 20px 0; direction: rtl;">
                    <thead>
                        <tr style="background: #2c3e50; color: white;">
                            <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">التاريخ</th>
                            <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">النوع</th>
                            <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">الوصف</th>
                            <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">الدائن</th>
                            <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">المبلغ</th>
                            <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">الرصيد بعد الحركة</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            transactionsToPrint.forEach(transaction => {
                let debtorName = 'غير محدد';
                if (transaction.debtor_id) {
                    const debtor = allAccounts.find(acc => acc.id === transaction.debtor_id);
                    debtorName = debtor ? debtor.name : transaction.debtor_name || 'غير محدد';
                } else if (transaction.debtor_name) {
                    debtorName = transaction.debtor_name;
                }

                content += `
                    <tr style="background: ${transaction.type === 'deposit' ? '#d4edda' : '#f8d7da'};">
                        <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">${formatDate(transaction.date)}</td>
                        <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">${transaction.type === 'deposit' ? 'إيداع' : 'مصروف'}</td>
                        <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">${transaction.description || 'بدون وصف'}</td>
                        <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">${debtorName}</td>
                        <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">${parseFloat(transaction.amount).toFixed(2)} د.ل</td>
                        <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">${parseFloat(transaction.balance_after).toFixed(2)} د.ل</td>
                    </tr>
                `;
            });

            content += `
                    </tbody>
                </table>
                <div style="margin-top: 30px; text-align: center; font-weight: bold;">
                    <p>إجمالي الإيداعات: ${totalDeposits.textContent} د.ل</p>
                    <p>إجمالي المصروفات: ${totalExpenses.textContent} د.ل</p>
                    <p>الرصيد الحالي: ${currentBalance.textContent} د.ل</p>
                    <p>عدد الحركات: ${totalTransactions.textContent}</p>
                </div>
            `;

            printContent.innerHTML = content;
            printPreview.style.display = 'block';
        }

        // Preview transactions
        function previewTransactions() {
            printTransactions('all');
        }

        // Print summary
        function printSummary() {
            const content = `
                <h2 style="text-align: center; margin-bottom: 30px;">ملخص الحساب</h2>
                <div style="margin: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; direction: rtl;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">الإحصائيات العامة</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
                        <div style="background: #2c3e50; color: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <h4>الرصيد الحالي</h4>
                            <p style="font-size: 1.5rem; font-weight: bold;">${currentBalance.textContent} د.ل</p>
                        </div>
                        <div style="background: #27ae60; color: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <h4>إجمالي الإيداعات</h4>
                            <p style="font-size: 1.5rem; font-weight: bold;">${totalDeposits.textContent} د.ل</p>
                        </div>
                        <div style="background: #e74c3c; color: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <h4>إجمالي المصروفات</h4>
                            <p style="font-size: 1.5rem; font-weight: bold;">${totalExpenses.textContent} د.ل</p>
                        </div>
                        <div style="background: #3498db; color: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <h4>عدد الحركات</h4>
                            <p style="font-size: 1.5rem; font-weight: bold;">${totalTransactions.textContent}</p>
                        </div>
                    </div>

                    <h3 style="margin-bottom: 20px; color: #2c3e50;">آخر 10 حركات</h3>
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0; direction: rtl;">
                        <thead>
                            <tr style="background: #2c3e50; color: white;">
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">التاريخ</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">النوع</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">الوصف</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">المبلغ</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            const recentTransactions = allTransactions.slice(0, 10);
            recentTransactions.forEach(transaction => {
                content += `
                    <tr style="background: ${transaction.type === 'deposit' ? '#d4edda' : '#f8d7da'};">
                        <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">${formatDate(transaction.date)}</td>
                        <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">${transaction.type === 'deposit' ? 'إيداع' : 'مصروف'}</td>
                        <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">${transaction.description || 'بدون وصف'}</td>
                        <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">${parseFloat(transaction.amount).toFixed(2)} د.ل</td>
                    </tr>
                `;
            });

            content += `
                        </tbody>
                    </table>

                    <h3 style="margin-bottom: 20px; color: #2c3e50; margin-top: 40px;">ملخص الدائنين</h3>
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0; direction: rtl;">
                        <thead>
                            <tr style="background: #2c3e50; color: white;">
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">اسم الدائن</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">الرصيد</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">عدد الحركات</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            allAccounts.forEach(account => {
                const accountTransactions = allTransactions.filter(t => t.debtor_id === account.id);
                const transactionCount = accountTransactions.length;
                const accountBalance = parseFloat(account.balance).toFixed(2);

                content += `
                    <tr>
                        <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">${account.name}</td>
                        <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">${accountBalance} د.ل</td>
                        <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">${transactionCount}</td>
                    </tr>
                `;
            });

            content += `
                        </tbody>
                    </table>
                </div>
            `;

            printContent.innerHTML = content;
            printPreview.style.display = 'block';
        }

        // Close print preview
        function closePrintPreview() {
            printPreview.style.display = 'none';
        }

        // Close advance receipt
        function closeAdvanceReceipt() {
            advanceReceipt.style.display = 'none';
        }

        // Clear all transactions
        async function clearAllTransactions() {
            if (!confirm('هل أنت متأكد أنك تريد مسح جميع الحركات؟ هذه العملية لا يمكن التراجع عنها.')) {
                return;
            }

            try {
                // Delete all transactions from Supabase
                const { error } = await supabase
                    .from('transactions')
                    .delete()
                    .not('id', 'is', null); // Delete all records

                if (error) throw error;

                // Update local data and UI
                allTransactions = [];
                filteredTransactions = [];
                renderTransactions();
                updateDashboardStats();

                alert('تم مسح جميع الحركات بنجاح');
            } catch (error) {
                console.error('Error clearing all transactions:', error);
                alert('حدث خطأ أثناء مسح الحركات: ' + error.message);
            }
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
