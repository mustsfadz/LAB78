<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الرصيد</title>

    <!-- Firebase SDK (Modern Module Syntax) -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCRy53YNiuCKOy3zj5045OIxDpYlFsGJlA",
            authDomain: "chac-f12dc.firebaseapp.com",
            projectId: "chac-f12dc",
            storageBucket: "chac-f12dc.firebasestorage.app",
            messagingSenderId: "1000528598684",
            appId: "1:1000528598684:web:08d3e0d354f687b0cbbf59",
            measurementId: "G-KKYYLGX5S4"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // =============================
        // المتغيرات العامة
        // =============================
        let allTransactions = [];
        let allCreditors = [];

        // =============================
        // عند تحميل الصفحة
        // =============================
        window.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('date').valueAsDate = new Date();
            await loadCreditors();
            await loadTransactions();
            updateDateTime();
            setInterval(updateDateTime, 1000);
        });

        // تحديث الوقت
        function updateDateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString('ar-SA');
        }

        // =============================
        // تحميل الدائنين
        // =============================
        async function loadCreditors() {
            try {
                const snapshot = await getDocs(collection(db, "creditors"));
                allCreditors = [];
                const creditorSelect = document.getElementById('creditor');
                const filterCreditorSelect = document.getElementById('filterCreditor');

                // مسح القوائم
                creditorSelect.innerHTML = '<option value="">-- اختر الدائن --</option>';
                filterCreditorSelect.innerHTML = '<option value="الكل">الكل</option>';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const creditor = { id: doc.id, ...data };
                    allCreditors.push(creditor);

                    // إضافة للقوائم المنسدلة
                    const option1 = document.createElement('option');
                    option1.value = creditor.name;
                    option1.textContent = creditor.name;
                    creditorSelect.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = creditor.name;
                    option2.textContent = creditor.name;
                    filterCreditorSelect.appendChild(option2);
                });
            } catch (error) {
                console.error("Error loading creditors: ", error);
                alert('حدث خطأ أثناء تحميل الدائنين.');
            }
        }

        // =============================
        // تحميل الحركات
        // =============================
        async function loadTransactions() {
            try {
                const q = query(collection(db, "transactions"), orderBy("timestamp", "desc"));
                const snapshot = await getDocs(q);
                allTransactions = [];
                const transactionsBody = document.getElementById('transactionsBody');

                if (snapshot.empty) {
                    transactionsBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">لا توجد حركات مالية مسجلة</td></tr>';
                    updateSummary(0, 0, 0);
                    document.getElementById('currentBalance').textContent = '0.00';
                    return;
                }

                let deposits = 0, expenses = 0, balance = 0, count = 0;
                transactionsBody.innerHTML = '';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const transaction = { id: doc.id, ...data };
                    allTransactions.push(transaction);

                    if (transaction.type === 'إيداع') {
                        deposits += transaction.amount;
                        balance += transaction.amount;
                    } else if (transaction.type === 'مصروف') {
                        expenses += transaction.amount;
                        balance -= transaction.amount;
                    }
                    count++;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${transaction.date}</td>
                        <td>${transaction.type}</td>
                        <td>${transaction.description || '-'}</td>
                        <td>${transaction.creditor || '-'}</td>
                        <td>${transaction.amount.toFixed(2)}</td>
                        <td>${balance.toFixed(2)}</td>
                        <td>
                            <button onclick="deleteTransaction('${doc.id}')">حذف</button>
                        </td>
                    `;
                    transactionsBody.appendChild(row);
                });

                updateSummary(deposits, expenses, count);
                document.getElementById('currentBalance').textContent = balance.toFixed(2);
            } catch (error) {
                console.error("Error loading transactions: ", error);
                alert('حدث خطأ أثناء تحميل الحركات.');
            }
        }

        // تحديث ملخص الحساب
        function updateSummary(deposits, expenses, count) {
            document.getElementById('totalDeposits').textContent = deposits.toFixed(2);
            document.getElementById('totalExpenses').textContent = expenses.toFixed(2);
            document.getElementById('totalTransactions').textContent = count;
        }

        // =============================
        // إضافة حركة مالية
        // =============================
        window.addTransaction = async function() {
            const date = document.getElementById('date').value;
            const type = document.getElementById('type').value;
            const description = document.getElementById('description').value;
            const creditor = document.getElementById('creditor').value;
            const amount = parseFloat(document.getElementById('amount').value);

            if (!date || !type || !amount || amount <= 0) {
                alert('يرجى ملء جميع الحقول بشكل صحيح');
                return;
            }

            try {
                await addDoc(collection(db, "transactions"), {
                    date: date,
                    type: type,
                    description: description,
                    creditor: creditor,
                    amount: amount,
                    timestamp: new Date()
                });

                alert('تمت إضافة الحركة بنجاح!');
                await loadTransactions();
                await loadCreditors();

                // إعادة تعيين النموذج
                document.getElementById('type').value = '';
                document.getElementById('amount').value = '';
                document.getElementById('description').value = '';
                document.getElementById('creditor').value = '';

            } catch (error) {
                console.error("Error adding transaction: ", error);
                alert('حدث خطأ أثناء إضافة الحركة.');
            }
        }

        // =============================
        // إضافة دائن جديد
        // =============================
        window.addCreditor = async function() {
            const name = document.getElementById('creditorName').value.trim();
            const phone = document.getElementById('creditorPhone').value.trim();
            const notes = document.getElementById('creditorNotes').value.trim();

            if (!name) {
                alert('يرجى إدخال اسم الدائن');
                return;
            }

            try {
                await addDoc(collection(db, "creditors"), {
                    name: name,
                    phone: phone,
                    notes: notes,
                    balance: 0,
                    transactionCount: 0,
                    createdAt: new Date()
                });

                alert('تمت إضافة الدائن بنجاح!');
                await loadCreditors();

                document.getElementById('creditorName').value = '';
                document.getElementById('creditorPhone').value = '';
                document.getElementById('creditorNotes').value = '';

            } catch (error) {
                console.error("Error adding creditor: ", error);
                alert('حدث خطأ أثناء إضافة الدائن.');
            }
        }

        // =============================
        // حذف حركة
        // =============================
        window.deleteTransaction = async function(id) {
            if (!confirm('هل أنت متأكد من حذف هذه الحركة؟')) return;

            try {
                await deleteDoc(doc(db, "transactions", id));
                alert('تم حذف الحركة بنجاح!');
                await loadTransactions();
                await loadCreditors();
            } catch (error) {
                console.error("Error deleting transaction: ", error);
                alert('حدث خطأ أثناء الحذف.');
            }
        }

        // =============================
        // حذف دائن (بدون حذف الحركات المرتبطة - للتبسيط)
        // =============================
        window.deleteCreditor = async function(id) {
            if (!confirm('هل أنت متأكد من حذف هذا الدائن؟')) return;

            try {
                await deleteDoc(doc(db, "creditors", id));
                alert('تم حذف الدائن بنجاح!');
                await loadCreditors();
                await loadTransactions();
            } catch (error) {
                console.error("Error deleting creditor: ", error);
                alert('حدث خطأ أثناء الحذف.');
            }
        }

        // =============================
        // الفلترة وإعادة التعيين (وظائف أساسية)
        // =============================
        window.applyFilter = function() {
            alert('وظيفة الفلترة تحتاج لتطوير إضافي. سيتم تطويرها لاحقًا.');
            // يمكنك تطويرها لاحقًا حسب الحاجة
        }

        window.resetFilter = function() {
            alert('تمت إعادة تعيين الفلاتر.');
            loadTransactions();
        }

        window.showOnlyExpenses = function() {
            alert('عرض المصروفات فقط - سيتم تطويره لاحقًا.');
        }

        window.showOnlyDeposits = function() {
            alert('عرض الإيداعات فقط - سيتم تطويره لاحقًا.');
        }

        window.showAll = function() {
            loadTransactions();
        }

        // =============================
        // مسح كل البيانات
        // =============================
        window.clearAllData = async function() {
            if (!confirm('⚠️ تحذير: سيتم حذف جميع البيانات بشكل دائم. هل أنت متأكد؟')) return;

            try {
                // حذف جميع الحركات
                const transactionsSnapshot = await getDocs(collection(db, "transactions"));
                const deletePromises = [];
                transactionsSnapshot.forEach(doc => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);

                // حذف جميع الدائنين
                const creditorsSnapshot = await getDocs(collection(db, "creditors"));
                const deletePromises2 = [];
                creditorsSnapshot.forEach(doc => {
                    deletePromises2.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises2);

                alert('تم مسح جميع البيانات بنجاح!');
                await loadTransactions();
                await loadCreditors();
            } catch (error) {
                console.error("Error clearing all data: ", error);
                alert('حدث خطأ أثناء المسح.');
            }
        }

        // =============================
        // وظائف الطباعة (نموذجية - بدون تغيير)
        // =============================
        window.printTransactions = function() {
            window.print();
        }

        window.previewPrint = function() {
            alert('معاينة الطباعة - سيتم تطويرها لاحقًا.');
        }

        window.printSummary = function() {
            alert('طباعة ملخص الحساب - سيتم تطويرها لاحقًا.');
        }

        window.printCurrentView = function() {
            window.print();
        }

        window.exportData = function() {
            alert('تصدير البيانات - سيتم تطويره لاحقًا.');
        }
    </script>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        .card { background: #f9f9f9; padding: 15px; margin: 15px 0; border-radius: 8px; }
        input, select, button { padding: 8px; margin: 5px; border-radius: 5px; border: 1px solid #ccc; }
        button { background: #007bff; color: white; cursor: pointer; }
        button:hover { background: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
        th { background: #f2f2f2; }
        .actions button { margin: 2px; padding: 5px 10px; }
        .success { color: green; }
        .error { color: red; }
        .balance-box { background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center; font-size: 1.2em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>نظام إدارة الرصيد</h1>
        <p>إدارة مالية بسيطة وفعالة</p>
        <p>آخر تحديث: <span id="lastUpdate">--:--:--</span> | <button onclick="exportData()">تصدير البيانات</button></p>

        <div class="balance-box">
            <h3>الرصيد الحالي: <span id="currentBalance">0.00</span> د.ل</h3>
            <p>إجمالي الإيداعات: <span id="totalDeposits">0.00</span> | إجمالي المصروفات: <span id="totalExpenses">0.00</span> | عدد الحركات: <span id="totalTransactions">0</span></p>
        </div>

        <!-- إضافة حركة جديدة -->
        <div class="card">
            <h2>إضافة حركة جديدة</h2>
            <select id="type">
                <option value="">-- اختر نوع الحركة --</option>
                <option value="إيداع">إيداع</option>
                <option value="مصروف">مصروف</option>
            </select>
            <input type="number" id="amount" placeholder="المبلغ (د.ل)" step="0.01">
            <input type="date" id="date">
            <select id="creditor">
                <option value="">-- اختر الدائن --</option>
                <!-- سيتم تعبئته ديناميكيًا -->
            </select>
            <input type="text" id="description" placeholder="الوصف">
            <button onclick="addTransaction()">إضافة الحركة</button>
        </div>

        <!-- فلترة الحركات -->
        <div class="card">
            <h2>فلترة الحركات</h2>
            <select id="filterType">
                <option value="الكل">الكل</option>
                <option value="إيداع">إيداع فقط</option>
                <option value="مصروف">مصروف فقط</option>
            </select>
            <select id="filterCreditor">
                <option value="الكل">الكل</option>
                <!-- سيتم تعبئته ديناميكيًا -->
            </select>
            <input type="date" id="filterFromDate" placeholder="من تاريخ">
            <input type="date" id="filterToDate" placeholder="إلى تاريخ">
            <button onclick="applyFilter()">تطبيق الفلترة</button>
            <button onclick="resetFilter()">إعادة تعيين</button>
            <button onclick="showOnlyExpenses()">إظهار المصروفات فقط</button>
            <button onclick="showOnlyDeposits()">إظهار الإيداعات فقط</button>
            <button onclick="showAll()">إظهار الكل</button>
        </div>

        <!-- طباعة -->
        <div class="card">
            <h2>خيارات الطباعة</h2>
            <button onclick="printTransactions()">طباعة سجل الحركات المالية</button>
            <button onclick="previewPrint()">معاينة قبل الطباعة</button>
            <button onclick="printSummary()">طباعة ملخص الحساب</button>
            <button onclick="printCurrentView()">طباعة العرض الحالي</button>
        </div>

        <!-- سجل الحركات -->
        <div class="card">
            <h2>سجل الحركات المالية</h2>
            <button onclick="clearAllData()" style="background: #dc3545;">مسح الكل</button>
            <table id="transactionsTable">
                <thead>
                    <tr>
                        <th>التاريخ</th>
                        <th>النوع</th>
                        <th>الوصف</th>
                        <th>الدائن</th>
                        <th>المبلغ</th>
                        <th>الرصيد بعد الحركة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="transactionsBody">
                    <tr>
                        <td colspan="7" style="text-align:center;">لا توجد حركات مالية مسجلة</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- إضافة دائن جديد -->
        <div class="card">
            <h2>إضافة حساب دائن جديد</h2>
            <input type="text" id="creditorName" placeholder="اسم الدائن">
            <input type="text" id="creditorPhone" placeholder="رقم الهاتف">
            <input type="text" id="creditorNotes" placeholder="ملاحظات">
            <button onclick="addCreditor()">إضافة الحساب</button>
        </div>

        <!-- قائمة الدائنين -->
        <div class="card">
            <h2>قائمة الدائنين</h2>
            <table id="creditorsTable">
                <thead>
                    <tr>
                        <th>اسم الدائن</th>
                        <th>رقم الهاتف</th>
                        <th>الرصيد</th>
                        <th>عدد الحركات</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="creditorsBody">
                    <tr>
                        <td colspan="5" style="text-align:center;">لا توجد حسابات دائنين مسجلة</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- نافذة معاينة الطباعة (مخفي افتراضيًا) -->
    <div id="printPreview" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; padding:20px; overflow:auto;">
        <h1>معاينة الطباعة</h1>
        <div id="printContent"></div>
        <button onclick="closePrintPreview()">إغلاق</button>
    </div>

    <script>
        // هذا السكريبت مخصص لوظائف الطباعة التي لا تتطلب Firebase
        function closePrintPreview() {
            document.getElementById('printPreview').style.display = 'none';
        }
    </script>
</body>
</html>
